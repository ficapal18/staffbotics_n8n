# docker-compose.yml
#
# Goal:
# - Portable n8n + Postgres (state in volumes)
# - Converge on every boot to:
#   - DB schema migrated
#   - workflow imported from ./workflows/staffbotics.json (if missing)
#   - exactly one workflow row with WF_NAME is active=true
#   - production webhooks registered and responding on /webhook/*
#
# Why 3 n8n-related services (init + server + poststart toggle)?
# - n8n-init (one-shot): ensures DB is ready + workflow exists + DB active flag is correct
# - n8n (long-running): registers production webhook routes at runtime from active workflows
# - n8n-poststart-toggle (one-shot): forces a UI-like "toggle active" after server is up,
#   which can re-register webhook routes in cases where a workflow is active in DB
#   but /webhook/* still returns "not registered".
#
# Files expected in repo:
# - ./workflows/staffbotics.json
# - ./scripts/n8n_init.sh
# - ./scripts/n8n_poststart_toggle.sh
#
# Notes:
# - Compose loads .env automatically from the same folder (default behavior).
# - Keep N8N_ENCRYPTION_KEY stable across machines, otherwise credentials break.
# - If you enable Basic Auth, the poststart-toggle MUST send -u user:pass to /rest/*.

services:
  # -----------------------------
  # Postgres (persistent state)
  # -----------------------------
  db:
    image: postgres:14
    container_name: staffbotics_db
    restart: unless-stopped

    volumes:
      - db_data:/var/lib/postgresql/data

    environment:
      # From your .env (fallbacks are safe for local dev)
      POSTGRES_DB: ${DB_POSTGRESDB_DATABASE:-n8n}
      POSTGRES_USER: ${DB_POSTGRESDB_USER:-n8n}
      POSTGRES_PASSWORD: ${DB_POSTGRESDB_PASSWORD:-n8n}

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_POSTGRESDB_USER:-n8n} -d ${DB_POSTGRESDB_DATABASE:-n8n}"]
      interval: 3s
      timeout: 3s
      retries: 40

  # ----------------------------------------------------------
  # n8n-init (one-shot): migrations + import + DB active flag
  # ----------------------------------------------------------
  n8n-init:
    build:
      context: .
      dockerfile: Dockerfile
    image: staffbotics_n8n_local:latest
    container_name: staffbotics_n8n_init
    restart: "no"

    depends_on:
      db:
        condition: service_healthy

    # We run a deterministic shell script instead of the default n8n entrypoint.
    entrypoint: ["/bin/sh", "-lc"]
    command: ["/data/scripts/n8n_init.sh"]

    environment:
      # --- n8n DB config (must match what the main n8n server will use) ---
      DB_TYPE: ${DB_TYPE:-postgresdb}
      DB_POSTGRESDB_HOST: ${DB_POSTGRESDB_HOST:-db}
      DB_POSTGRESDB_PORT: ${DB_POSTGRESDB_PORT:-5432}
      DB_POSTGRESDB_DATABASE: ${DB_POSTGRESDB_DATABASE:-n8n}
      DB_POSTGRESDB_USER: ${DB_POSTGRESDB_USER:-n8n}
      DB_POSTGRESDB_PASSWORD: ${DB_POSTGRESDB_PASSWORD:-n8n}

      # --- required for portability of credentials ---
      N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY}

      # --- workflow import/activation settings ---
      WF_NAME: ${WF_NAME}
      WF_JSON_PATH: /data/workflows/staffbotics.json

      # --- used only for the temporary bootstrap start inside init ---
      N8N_PORT: ${N8N_PORT:-5678}

  # -----------------------------------
  # n8n (main server / long-running)
  # -----------------------------------
  n8n:
    build:
      context: .
      dockerfile: Dockerfile
    image: staffbotics_n8n_local:latest
    container_name: staffbotics_n8n
    restart: unless-stopped

    depends_on:
      db:
        condition: service_healthy
      n8n-init:
        condition: service_completed_successfully

    ports:
      - "${N8N_PORT:-5678}:5678"

    volumes:
      # n8n user folder (contains settings, encryption key usage, etc.)
      - n8n_data:/home/node/.n8n

    environment:
      # --- n8n DB config ---
      DB_TYPE: ${DB_TYPE:-postgresdb}
      DB_POSTGRESDB_HOST: ${DB_POSTGRESDB_HOST:-db}
      DB_POSTGRESDB_PORT: ${DB_POSTGRESDB_PORT:-5432}
      DB_POSTGRESDB_DATABASE: ${DB_POSTGRESDB_DATABASE:-n8n}
      DB_POSTGRESDB_USER: ${DB_POSTGRESDB_USER:-n8n}
      DB_POSTGRESDB_PASSWORD: ${DB_POSTGRESDB_PASSWORD:-n8n}

      # --- required for portability of credentials ---
      N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY}

      # --- server settings ---
      N8N_HOST: ${N8N_HOST:-localhost}
      N8N_PORT: ${N8N_PORT:-5678}
      N8N_PROTOCOL: ${N8N_PROTOCOL:-http}
      N8N_EDITOR_BASE_URL: ${N8N_EDITOR_BASE_URL:-http://localhost:5678}

      # --- auth settings (optional, but you have them enabled) ---
      N8N_BASIC_AUTH_USER: ${N8N_BASIC_AUTH_USER}
      N8N_BASIC_AUTH_PASSWORD: ${N8N_BASIC_AUTH_PASSWORD}

      # If you truly want "single-user" style setups, this is common.
      # (If you use user management instead, adjust accordingly.)
      N8N_USER_MANAGEMENT_DISABLED: ${N8N_USER_MANAGEMENT_DISABLED:-true}
      N8N_USER_EMAIL: ${N8N_USER_EMAIL:-admin@admin.com}

      # --- optional logging/config ---
      N8N_LOG_LEVEL: ${N8N_LOG_LEVEL:-info}

      # Allow require() in Function/Code nodes (dev convenience)
      NODE_FUNCTION_ALLOW_EXTERNAL: ${NODE_FUNCTION_ALLOW_EXTERNAL:-*}
      NODE_FUNCTION_ALLOW_BUILTIN: ${NODE_FUNCTION_ALLOW_BUILTIN:-*}

  # -------------------------------------------------------------------
  # n8n-poststart-toggle (one-shot): force UI-like activate toggle
  # -------------------------------------------------------------------
  n8n-poststart-toggle:
    image: staffbotics_n8n_local:latest
    container_name: staffbotics_n8n_poststart_toggle
    restart: "no"

    # Wait until the main server container has started.
    # (We still wait on /healthz inside the script for readiness.)
    depends_on:
      n8n:
        condition: service_started

    entrypoint: ["/bin/sh", "-lc"]
    command: ["/data/scripts/n8n_poststart_toggle.sh"]

    environment:
      # --- DB lookup for workflow ID by name ---
      DB_POSTGRESDB_HOST: ${DB_POSTGRESDB_HOST:-db}
      DB_POSTGRESDB_PORT: ${DB_POSTGRESDB_PORT:-5432}
      DB_POSTGRESDB_DATABASE: ${DB_POSTGRESDB_DATABASE:-n8n}
      DB_POSTGRESDB_USER: ${DB_POSTGRESDB_USER:-n8n}
      DB_POSTGRESDB_PASSWORD: ${DB_POSTGRESDB_PASSWORD:-n8n}

      # Workflow name to target
      WF_NAME: ${WF_NAME}

      # Internal URL to reach n8n from inside the compose network
      N8N_INTERNAL_URL: http://n8n:5678

      # IMPORTANT:
      # If Basic Auth is enabled on n8n, /rest/* is protected.
      # The script must authenticate when PATCHing /rest/workflows/:id.
      N8N_BASIC_AUTH_USER: ${N8N_BASIC_AUTH_USER}
      N8N_BASIC_AUTH_PASSWORD: ${N8N_BASIC_AUTH_PASSWORD}

      # Optional verification probe (must match your webhook node)
      WEBHOOK_METHOD: POST
      WEBHOOK_PATH: staffbotics-batch

volumes:
  db_data:
  n8n_data:
